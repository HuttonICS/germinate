/**************************************************/
/*              GERMINATE 3                       */
/*              CHANGELOG v3.3.1                  */
/**************************************************/


/* CHANGELOG */

 - CHG: Disabled mouse-wheel scrolling on locator map.
 - ADD: Added option to filter datasets table by count and datapoints.
 - FIX: Fixed issue with Maintenance-Mode.
 - FIX: Fixed issue with spaces in file paths.
 - CHG: Improved performance of 'germinatebase' export of whole dataset.
 - FIX: Fixed issue with y-axis tick formats in d3.js multi-line chart.
 - FIX: Fixed issue on admin-config page where the available pages weren't updated as expected.
 - ADD: Added checkbox column header for item marking columns to easily mark all items.
 - CHG: Updated FontAwesome to version 4.5.0.
 - CHG: Major code-cleanup.
 - ADD: Major Javadoc additions.
 - ADD: Added pedigree information to passport page. Now uses the database tables 'pedigree', 'pedigreedefinitions', 'pedigreenotations' and 'pedigreedescriptions'.
 - ADD: Added color picker widget to administrator configuration page to make customization of the page easier.
 - ADD: Added "Technologies" section to the documentation. This section explains which third-party libraries (Java, JavaScript, Fonts) we use and how we use them.
 - ADD: Added property that decides if the main website logo (top-left) contains links itself. Usually clicking the whole logo will redirect to "home", however, since we switched to SVG files, these can contain links on their own (for either the whole logo or even sections of it), so we allow to prioritize the internal links and disable the link to "home" by setting 'Germinate.Template.Logo.Contains.Link' to 'true'.
 - CHG: The search page will now show all tabs regardless of page availability, whereas before it would only show the tabs of those types that have their details page enabled, e.g. the 'marker-details' page had to be enabled for the 'marker' search tab to show up. Now all tabs show and the table that shows the search results will only contain links to the details page if available.
 - CHG: Changes to the admin configuration page ('#admin-config') are now persistent changes to the config.properties file. Restarting Tomcat or restarting the web-application will not erase changes made to the configuration anymore.
 - CHG: '#news' and '#about' are now publicly visible, no matter what.
 - ADD: Added 'Germinate.Gallery.Images.Per.Page' property to config.properties that determines how many images per page each gallery will show (default: 4).
 - FIX: Fixed session persistency bug.
 - CHG: The external data directory can now be used to not only externalize the actual 'data' folder, but also 'download', 'res' and 'apps'. Germinate will prefer the files found in that location, but fall back to the files bundled with Germinate itself. To use this feature, set the 'Germinate.ExternalDataFolder' property to the directory containing the previously mentioned folders (e.g. '/srv/data/germinate/germinate-template' which then contains 'data', etc.).
 - CHG: The automatic image scaler will now work with the external data directory image folder as well.
 - CHG: Restyled passport page. Moved information representation to list format when a table didn't add any functionality to it.
 - DEL: Removed legacy classes related to old table structure.
 - DEL: Removed Apache POI library dependencies.
 - CHG: D3.js chart download context menu is now available on IE as well. However, it only shows the "download data file" option, as IE doesn't support the required functionality (or rather prohibits it).
 - FIX: Client settings are no longer shared between user logins. Each user has its own settings even when the second user logs in after the first has logged out (in the same browser).
 - CHG: Moved cookie creation to server.
 - CHG: Removed checkbox column from datasets table if the continue button isn't available, as there is no point in selecting datasets in this case.
 - FIX: Fixed group permission issue where admins weren't able to see all groups.
 - CHG: Added new property 'Germinate.Template.GradientColors' that allows customization of the gradients shown on the website.
 - ADD: Added parallax scrolling banners to selected pages.
 - ADD: Added new property 'Germinate.Template.Show.Parallax.Banner' that determines if the parallax banner is shown or not.
 - CHG: 'germinatebase.name' is now a required field and will be used for genotypic data export. It represents the BRAPI 'defaultDisplayName', a human-readable and meaningful name for the accession.
 - ADD: Added data statistics page (#data-stats) with basic statistics.
 - CHG: Applied some changes to the template.
 - FIX: Fixed rare issue with "select" element selection where elements weren't selected if the number of items matched the visible rows and the selection happened by dragging from inside the select element to outside the select element.
 - CHG: Improved performance of dataset related queries by about 33%!
 - ADD: Added page size selection widget to paginated tables.
 - CHG: Further improved the performance of dataset related queries by pre-calculating dataset sizes and storing the result in the 'datasetmeta' table. This is re-calculated every hour to ensure it's reasonably up-to-date.
 - CHG: Initial adaptation of the Java 8 Streams API on the server.
 - CHG: Improved performance of trials/phenotype export page (phenotypes only retrieved once in total instead of once per "tab").
 - NEW: Added HDF5 functionalities for genotypic data export.
 - CHG: Switched genotypic data export over to HDF5 by default.
 - NEW: Added "Select all" buttons to multi-select boxes.
 - NEW: Added operator selector to table filter. Users can now switch between logical "AND" and "OR" combination of query fields.
 - NEW: Added column filtering to marker table on map-details page.
 - DEL: Removed phenotype data export preview as it serves no good purpose. The data is already exported, so why not just download it?
 - DEL: Removed two of the four maps (the weighted ones) on #geography as they don't really provide much new information.
 - ADD: Added country flags to more tables containing country information.

/* MIGRATION */

  - Migrating from 3.3.0 to 3.3.1:

    - If you're storing your genotypic data in a flat file, please convert them using Flapjack to HDF5. Run the following command to do so:
    	java -cp flapjack.jar jhi.flapjack.io.cmd.GenotypeToHdf5Converter -genotypes=<old genotype file>.txt -hdf5=<new hdf5 file>.hdf5

    - Change the entry in `datasets`.`source_file` to point to the newly created HDF5 file.

    - New translatable text has been added. The following properties can be changed in your "Text.properties" file and the according translation files:

      page.passport.pedigree.title=Pedigree
      notification.color.picker.at.least.one=At least one color is required.
      notification.color.picker.at.least.two=At least two colors are required.
      notification.error.writing.file=Failed to write to file on server.
      notification.incinsistancy.count.result.size=Inconsistancy between total number of items and count.
      page.trials.individual.not.available.for.char=Please note that the individual chart page isn''t available for non-numeric phenotypes.
      page.about.button.add.group=Add group
      page.about.button.delete.group=Delete group
      page.geographic.search.tab.point=Point search
      page.geographic.search.tab.polygon=Polygon search
      menu.about.germinate=about germinate
      menu.about.project=about project
      page.about.project.title=About this project
      page.about.project.text=
      page.data.statistics.accessions.per.country.title=Accessions per country
      page.data.statistics.accessions.per.country.text=This chart shows the distribution of accessions. For each country the number of accessions collected in this country is color-coded.
      page.data.statistics.taxonomy.title=Accessions grouped by taxonomy
      page.data.statistics.taxonomy.text=This pie chart visualizes the percentage of accessions for each taxonomy. Each slice represents a taxonomy. Hovering over a slice will show the actual number of accessions.
      page.trials.overview.select.phenotypes=Select phenotypes
      page.trials.overview.select.years=Select years
      general.select.all=Select all
      column.unit.name=Unit
      column.phenotype.value=Value

		- Make sure that `germinatebase`.`name` isn't empty and contains what we call the "default display name". This will be used during all sorts of exports from Germinate to provide the user with a meaningful name of the accession.

    - Run this against the database:

		/* Change the type of `general_identifier` from `int` to `varchar` */
		ALTER TABLE `germinatebase` MODIFY COLUMN `general_identifier` varchar(255) NOT NULL AFTER `id`;

		/* Allow setting the `unit_id` to NULL */
		ALTER TABLE `phenotypes` MODIFY COLUMN `unit_id`  int(11) NULL COMMENT 'Foreign Key to units (units.id).' AFTER `datatype`;

		/* Set `dataset_state_id` to NOT NULL (is required now) */
		ALTER TABLE `datasets` DROP FOREIGN KEY `datasets_ibfk_2`;
		ALTER TABLE `datasets` MODIFY COLUMN `dataset_state_id`  int(11) NOT NULL DEFAULT 1 COMMENT 'Foreign key to datasetstates (datasetstates.id).' AFTER `created_by`;
		ALTER TABLE `datasets` ADD CONSTRAINT `datasets_ibfk_2` FOREIGN KEY (`dataset_state_id`) REFERENCES `datasetstates` (`id`) ON DELETE CASCADE ON UPDATE CASCADE;

		/* Remove the default value of the `contact` column */
		ALTER TABLE `institutions` MODIFY COLUMN `contact`  varchar(255) CHARACTER SET latin1 COLLATE latin1_swedish_ci NULL DEFAULT NULL COMMENT 'The contact at the institute which should be used for correspondence.' AFTER `country_id`;

		/* Create a new table to store database versions */
		CREATE TABLE IF NOT EXISTS `databaseversions` (
			`id`  int(11) NOT NULL AUTO_INCREMENT ,
			`name`  varchar(255) NOT NULL ,
			`number`  varchar(255) NOT NULL ,
			`created_on`  datetime NULL ,
			`updated_on`  timestamp NULL ON UPDATE CURRENT_TIMESTAMP ,
			PRIMARY KEY (`id`)
		);

		/* Insert the latest versions */
		INSERT IGNORE INTO databaseversions (id, NAME, number) VALUES (1, "Dipper", "3.3.0"), (2, "Dipper", "3.3.1");

		/* Allow `source_file` in the datasets table to be null */
		ALTER TABLE `datasets` MODIFY COLUMN `source_file` varchar(255) CHARACTER SET latin1 COLLATE latin1_swedish_ci NULL DEFAULT NULL AFTER `date`;

		/* Force the `name` column to be NOT NULL, because this will be used as the "default display name" of the accession */
		ALTER TABLE `germinatebase` MODIFY COLUMN `name`  varchar(255) CHARACTER SET latin1 COLLATE latin1_swedish_ci NOT NULL AFTER `number`;

		/* Add new datasets meta table to store data counrs */
		CREATE TABLE IF NOT EXISTS `datasetmeta` (
			`id`  int(11) NOT NULL AUTO_INCREMENT ,
			`dataset_id`  int(11) NOT NULL ,
			`nr_of_data_objects`  int(11) NOT NULL ,
			`nr_of_data_points`  int(11) NOT NULL ,
			PRIMARY KEY (`id`),
			CONSTRAINT `datasetmeta_ibfk_datasets` FOREIGN KEY (`dataset_id`) REFERENCES `datasets` (`id`) ON DELETE CASCADE ON UPDATE CASCADE
		);

		/* Adds a new index to the phenotypedata table */
		ALTER TABLE `phenotypedata` ADD INDEX `phenotypedata_recording_date` (`recording_date`) USING BTREE;

		/* Adds a new index to the phenotypedata table */
		ALTER TABLE phenotypedata ADD INDEX `trials_query_index` (`phenotype_id`, `germinatebase_id`, `location_id`, `trialseries_id`, `recording_date`, `treatment_id`, `dataset_id`, `phenotype_value`) USING BTREE;