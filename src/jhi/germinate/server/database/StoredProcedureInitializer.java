/*
 *  Copyright 2017 Sebastian Raubach and Paul Shaw from the
 *  Information and Computational Sciences Group at JHI Dundee
 *
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 */

package jhi.germinate.server.database;


/**
 * {@link StoredProcedureInitializer} contains methods to drop and create stored procedures.
 *
 * @author Sebastian Raubach
 */
public class StoredProcedureInitializer extends DatabaseInitializer
{
	public static final String PHENOTYPE_DATA                         = "phenotype_data";
	public static final String PHENOTYPE_DATA_PHENOTYPE               = "phenotype_data_phenotype";
	public static final String PHENOTYPE_DATA_COMPLETE                = "phenotype_data_complete";
	public static final String COMPOUND_DATA                          = "compound_data";
	public static final String COMPOUND_DATA_COMPOUND                 = "compound_data_compound";
	public static final String COMPOUND_DATA_COMPLETE                 = "compound_data_complete";
	public static final String GERMINATEBASE_ATTRIBUTE_DATA           = "germinatebase_attribute_data";
	public static final String GERMINATEBASE_ATTRIBUTE_GROUP_DATA     = "germinatebase_attribute_group_data";
	public static final String GERMINATEBASE_ATTRIBUTE_ACCESSION_DATA = "germinatebase_attribute_accession_data";
	public static final String DATASET_META                           = "dataset_meta";
	public static final String UPDATE_AUTO_INCREMENT                  = "update_auto_increment";
//	public static final String TABLE_SEARCH                       = "table_search";

	private static final String DROP_PROCEDURE   = "DROP PROCEDURE IF EXISTS %s";
	private static final String CREATE_PROCEDURE = "CREATE PROCEDURE %s %s";

	private static final String QUERY_PHENOTYPE_DATA           = "(IN groupIds TEXT, IN datasetIds TEXT, IN phenotypeIds TEXT) BEGIN SET @SQL = NULL; SET @@group_concat_max_len = 64000000; SET @QRY = CONCAT('SELECT GROUP_CONCAT(DISTINCT CONCAT(\"MAX(IF(`phenotype_id` = \", `phenotype_id`,\",phenotype_value,NULL)) AS \", \"`\", CONCAT(phenotypes.`name`, IF(ISNULL(phenotypes.unit_id), \"\", CONCAT(\" [\", units.unit_abbreviation, \"]\"))), \"`\")) INTO @SQL FROM phenotypedata LEFT JOIN phenotypes ON phenotypes.id = phenotypedata.phenotype_id LEFT JOIN germinatebase ON germinatebase.id = phenotypedata.germinatebase_id LEFT JOIN units ON units.id = phenotypes.unit_id WHERE phenotypedata.dataset_id IN (', datasetIds, ') AND phenotype_id IN (', phenotypeIds, ')'); PREPARE stmtone FROM @QRY; EXECUTE stmtone; DEALLOCATE PREPARE stmtone; IF @SQL IS NULL THEN SELECT NULL as ERROR; ELSE SET @SQL = CONCAT('SELECT germinatebase.name, datasets.description AS dataset_name, licenses.name AS license_name, germinatebase.id AS dbId, germinatebase.general_identifier, treatments.description AS treatments_description, ', @SQL,' FROM phenotypedata LEFT JOIN germinatebase ON germinatebase.id = phenotypedata.germinatebase_id LEFT JOIN groupmembers ON germinatebase.id = groupmembers.foreign_id LEFT JOIN datasets ON datasets.id = phenotypedata.dataset_id LEFT JOIN licenses ON licenses.id = datasets.license_id LEFT JOIN treatments ON treatments.id = phenotypedata.treatment_id WHERE groupmembers.group_id IN (', groupIds, ') AND datasets.id IN (', datasetIds, ') GROUP BY germinatebase.id, treatment_id, dataset_id'); PREPARE stmt FROM @SQL; EXECUTE stmt; DEALLOCATE PREPARE stmt; END IF; END";
	private static final String QUERY_PHENOTYPE_DATA_PHENOTYPE = "(IN datasetIds TEXT, IN phenotypeIds TEXT) BEGIN SET @SQL = NULL; SET @@group_concat_max_len = 64000000; SET @QRY = CONCAT('SELECT GROUP_CONCAT(DISTINCT CONCAT(\"MAX(IF(`phenotype_id` = \", `phenotype_id`,\",phenotype_value,NULL)) AS \", \"`\", CONCAT(phenotypes.`name`, IF(ISNULL(phenotypes.unit_id), \"\", CONCAT(\" [\", units.unit_abbreviation, \"]\"))), \"`\")) INTO @SQL FROM phenotypedata LEFT JOIN phenotypes ON phenotypes.id = phenotypedata.phenotype_id LEFT JOIN germinatebase ON germinatebase.id = phenotypedata.germinatebase_id LEFT JOIN units ON units.id = phenotypes.unit_id WHERE phenotypedata.dataset_id IN (', datasetIds, ') AND phenotype_id IN (', phenotypeIds, ')'); PREPARE stmtone FROM @QRY; EXECUTE stmtone; DEALLOCATE PREPARE stmtone; IF @SQL IS NULL THEN SELECT NULL as ERROR; ELSE SET @SQL = CONCAT('SELECT germinatebase.name, datasets.description AS dataset_name, licenses.name AS license_name, germinatebase.id AS dbId, germinatebase.general_identifier, treatments.description AS treatments_description, ', @SQL,' FROM phenotypedata LEFT JOIN germinatebase ON germinatebase.id = phenotypedata.germinatebase_id LEFT JOIN groupmembers ON germinatebase.id = groupmembers.foreign_id LEFT JOIN datasets ON datasets.id = phenotypedata.dataset_id LEFT JOIN licenses ON licenses.id = datasets.license_id LEFT JOIN treatments ON treatments.id = phenotypedata.treatment_id WHERE datasets.id IN (', datasetIds, ') GROUP BY germinatebase.id, treatment_id, dataset_id'); PREPARE stmt FROM @SQL; EXECUTE stmt; DEALLOCATE PREPARE stmt; END IF; END";
	private static final String QUERY_PHENOTYPE_DATA_COMPLETE  = "(IN datasetIds TEXT) BEGIN SET @SQL = NULL; SET @@group_concat_max_len = 64000000; SET @QRY = CONCAT('SELECT GROUP_CONCAT(DISTINCT CONCAT(\"MAX(IF(`phenotype_id` = \", `phenotype_id`,\",phenotype_value,NULL)) AS \", \"`\", CONCAT(phenotypes.`name`, IF(ISNULL(phenotypes.unit_id), \"\", CONCAT(\" [\", units.unit_abbreviation, \"]\"))), \"`\")) INTO @SQL FROM phenotypedata LEFT JOIN phenotypes ON phenotypes.id = phenotypedata.phenotype_id LEFT JOIN germinatebase ON germinatebase.id = phenotypedata.germinatebase_id LEFT JOIN units ON units.id = phenotypes.unit_id WHERE phenotypedata.dataset_id IN (', datasetIds, ')'); PREPARE stmtone FROM @QRY; EXECUTE stmtone; DEALLOCATE PREPARE stmtone; IF @SQL IS NULL THEN SELECT NULL as ERROR; ELSE SET @SQL = CONCAT('SELECT germinatebase.name, datasets.description AS dataset_name, licenses.name AS license_name, germinatebase.id AS dbId, germinatebase.general_identifier, treatments.description AS treatments_description, ', @SQL,' FROM phenotypedata LEFT JOIN germinatebase ON germinatebase.id = phenotypedata.germinatebase_id LEFT JOIN datasets ON datasets.id = phenotypedata.dataset_id LEFT JOIN licenses ON licenses.id = datasets.license_id LEFT JOIN treatments ON treatments.id = phenotypedata.treatment_id WHERE datasets.id IN (', datasetIds, ') GROUP BY germinatebase.id, treatment_id, dataset_id'); PREPARE stmt FROM @SQL; EXECUTE stmt; DEALLOCATE PREPARE stmt; END IF; END";

	private static final String QUERY_COMPOUND_DATA          = "(IN groupIds TEXT, IN datasetIds TEXT, IN compoundIds TEXT) BEGIN SET @SQL = NULL; SET @@group_concat_max_len = 64000000; SET @QRY = CONCAT('SELECT GROUP_CONCAT(DISTINCT CONCAT(\"MAX(IF(`compound_id` = \", `compound_id`,\",compound_value,NULL)) AS \", \"`\", CONCAT(compounds.`name`, IF(ISNULL(compounds.unit_id), \"\", CONCAT(\" [\", units.unit_abbreviation, \"]\"))), \"`\")) INTO @SQL FROM compounddata LEFT JOIN compounds ON compounds.id = compounddata.compound_id LEFT JOIN germinatebase ON germinatebase.id = compounddata.germinatebase_id LEFT JOIN units ON units.id = compounds.unit_id WHERE compounddata.dataset_id IN (', datasetIds, ') AND compound_id IN (', compoundIds, ')'); PREPARE stmtone FROM @QRY; EXECUTE stmtone; DEALLOCATE PREPARE stmtone; IF @SQL IS NULL THEN SELECT NULL as ERROR; ELSE SET @SQL = CONCAT('SELECT germinatebase.name, datasets.description AS dataset_name, germinatebase.id AS dbId, germinatebase.general_identifier, ', @SQL,' FROM compounddata LEFT JOIN germinatebase ON germinatebase.id = compounddata.germinatebase_id LEFT JOIN groupmembers ON germinatebase.id = groupmembers.foreign_id LEFT JOIN datasets ON datasets.id = compounddata.dataset_id  WHERE groupmembers.group_id IN (', groupIds, ') AND datasets.id IN (', datasetIds, ') GROUP BY germinatebase.id, dataset_id'); PREPARE stmt FROM @SQL; EXECUTE stmt; DEALLOCATE PREPARE stmt; END IF; END";
	private static final String QUERY_COMPOUND_DATA_COMPOUND = "(IN datasetIds TEXT, IN compoundIds TEXT) BEGIN SET @SQL = NULL; SET @@group_concat_max_len = 64000000; SET @QRY = CONCAT('SELECT GROUP_CONCAT(DISTINCT CONCAT(\"MAX(IF(`compound_id` = \", `compound_id`,\",compound_value,NULL)) AS \", \"`\", CONCAT(compounds.`name`, IF(ISNULL(compounds.unit_id), \"\", CONCAT(\" [\", units.unit_abbreviation, \"]\"))), \"`\")) INTO @SQL FROM compounddata LEFT JOIN compounds ON compounds.id = compounddata.compound_id LEFT JOIN germinatebase ON germinatebase.id = compounddata.germinatebase_id LEFT JOIN units ON units.id = compounds.unit_id WHERE compounddata.dataset_id IN (', datasetIds, ') AND compound_id IN (', compoundIds, ')'); PREPARE stmtone FROM @QRY; EXECUTE stmtone; DEALLOCATE PREPARE stmtone; IF @SQL IS NULL THEN SELECT NULL as ERROR; ELSE SET @SQL = CONCAT('SELECT germinatebase.name, datasets.description AS dataset_name, germinatebase.id AS dbId, germinatebase.general_identifier, ', @SQL,' FROM compounddata LEFT JOIN germinatebase ON germinatebase.id = compounddata.germinatebase_id LEFT JOIN groupmembers ON germinatebase.id = groupmembers.foreign_id LEFT JOIN datasets ON datasets.id = compounddata.dataset_id  WHERE datasets.id IN (', datasetIds, ') GROUP BY germinatebase.id, dataset_id'); PREPARE stmt FROM @SQL; EXECUTE stmt; DEALLOCATE PREPARE stmt; END IF; END";
	private static final String QUERY_COMPOUND_DATA_COMPLETE = "(IN datasetIds TEXT) BEGIN SET @SQL = NULL; SET @@group_concat_max_len = 64000000; SET @QRY = CONCAT('SELECT GROUP_CONCAT(DISTINCT CONCAT(\"MAX(IF(`compound_id` = \", `compound_id`,\",compound_value,NULL)) AS \", \"`\", CONCAT(compounds.`name`, IF(ISNULL(compounds.unit_id), \"\", CONCAT(\" [\", units.unit_abbreviation, \"]\"))), \"`\")) INTO @SQL FROM compounddata LEFT JOIN compounds ON compounds.id = compounddata.compound_id LEFT JOIN germinatebase ON germinatebase.id = compounddata.germinatebase_id LEFT JOIN units ON units.id = compounds.unit_id WHERE compounddata.dataset_id IN (', datasetIds, ')'); PREPARE stmtone FROM @QRY; EXECUTE stmtone; DEALLOCATE PREPARE stmtone; IF @SQL IS NULL THEN SELECT NULL as ERROR; ELSE SET @SQL = CONCAT('SELECT germinatebase.name, datasets.description AS dataset_name, germinatebase.id AS dbId, germinatebase.general_identifier, ', @SQL,' FROM compounddata LEFT JOIN germinatebase ON germinatebase.id = compounddata.germinatebase_id LEFT JOIN datasets ON datasets.id = compounddata.dataset_id WHERE datasets.id IN (', datasetIds, ') GROUP BY germinatebase.id, dataset_id'); PREPARE stmt FROM @SQL; EXECUTE stmt; DEALLOCATE PREPARE stmt; END IF; END";

	private static final String QUERY_GERMINATEBASE_ATTRIBUTE_DATA = "(IN includeAtts TINYINT) BEGIN SET @SQL = NULL; SET @@group_concat_max_len = 64000000; SET @QRY = CONCAT(' SELECT GROUP_CONCAT(DISTINCT CONCAT( \"MAX(CASE WHEN attribute_id = \", `attributes`.`id`, \" THEN attributedata.value END) AS \", \"`\", `attributes`.`name`, \"`\")) INTO @SQL FROM attributedata LEFT JOIN attributes ON attributes.id = attributedata.id WHERE attributes.target_table = \"germinatebase\";'); PREPARE stmtone FROM @QRY; EXECUTE stmtone; DEALLOCATE PREPARE stmtone; IF (@SQL IS NULL) OR NOT includeAtts THEN SET @SQL = CONCAT(' SELECT germinatebase.*, locations.id AS locations_id, locations.state AS locations_state, locations.region AS locations_region, locations.site_name AS locations_site_name, locations.elevation AS locations_elevation, locations.latitude AS locations_latitude, locations.longitude AS locations_longitude, countries.id AS countries_id, countries.country_code2 AS countries_country_code2, countries.country_code3 AS countries_country_code3, countries.country_name AS countries_country_name, subtaxa.id AS subtaxa_id, subtaxa.subtaxa_author AS subtaxa_subtaxa_author, subtaxa.taxonomic_identifier AS subtaxa_taxonomic_identifier, taxonomies.id AS taxonomies_id, taxonomies.genus AS taxonomies_genus, taxonomies.species AS taxonomies_species, taxonomies.species_author AS taxonomies_species_author, taxonomies.cropname AS taxonomies_crop_name, taxonomies.ploidy AS taxonomies_ploidy FROM germinatebase LEFT JOIN locations ON germinatebase.location_id = locations.id LEFT JOIN countries ON countries.id = locations.country_id LEFT JOIN subtaxa ON subtaxa.id = germinatebase.subtaxa_id LEFT JOIN taxonomies ON taxonomies.id = germinatebase.taxonomy_id GROUP BY germinatebase.id'); PREPARE stmt FROM @sql; EXECUTE stmt; DEALLOCATE PREPARE stmt; ELSE SET @SQL = CONCAT(' SELECT germinatebase.*, locations.id AS locations_id, locations.state AS locations_state, locations.region AS locations_region, locations.site_name AS locations_site_name, locations.elevation AS locations_elevation, locations.latitude AS locations_latitude, locations.longitude AS locations_longitude, countries.id AS countries_id, countries.country_code2 AS countries_country_code2, countries.country_code3 AS countries_country_code3, countries.country_name AS countries_country_name, subtaxa.id AS subtaxa_id, subtaxa.subtaxa_author AS subtaxa_subtaxa_author, subtaxa.taxonomic_identifier AS subtaxa_taxonomic_identifier, taxonomies.id AS taxonomies_id, taxonomies.genus AS taxonomies_genus, taxonomies.species AS taxonomies_species, taxonomies.species_author AS taxonomies_species_author, taxonomies.cropname AS taxonomies_crop_name, taxonomies.ploidy AS taxonomies_ploidy, ', @SQL, ' FROM germinatebase LEFT JOIN locations ON germinatebase.location_id = locations.id LEFT JOIN countries ON countries.id = locations.country_id LEFT JOIN subtaxa ON subtaxa.id = germinatebase.subtaxa_id LEFT JOIN taxonomies ON taxonomies.id = germinatebase.taxonomy_id LEFT JOIN attributedata ON germinatebase.id = attributedata.foreign_id LEFT JOIN attributes ON attributes.id = attributedata.attribute_id WHERE attributes.target_table = \"germinatebase\" GROUP BY germinatebase.id'); PREPARE stmt FROM @sql; EXECUTE stmt; DEALLOCATE PREPARE stmt; END IF; END";

	private static final String QUERY_GERMINATEBASE_ATTRIBUTE_GROUP_DATA = "(IN includeAtts TINYINT, IN groupId TEXT) BEGIN SET @SQL = NULL; SET @@group_concat_max_len = 32000; SET @QRY = CONCAT(' SELECT GROUP_CONCAT(DISTINCT CONCAT( \"MAX(CASE WHEN attribute_id = \", `attributes`.`id`, \" THEN attributedata.value END) AS \", \"`\", `attributes`.`name`, \"`\")) INTO @SQL FROM attributedata LEFT JOIN attributes ON attributes.id = attributedata.id WHERE attributes.target_table = \"germinatebase\";'); PREPARE stmtone FROM @QRY; EXECUTE stmtone; DEALLOCATE PREPARE stmtone; IF (@SQL IS NULL) OR NOT includeAtts THEN SET @SQL = CONCAT(' SELECT germinatebase.*, locations.id AS locations_id, locations.state AS locations_state, locations.region AS locations_region, locations.site_name AS locations_site_name, locations.elevation AS locations_elevation, locations.latitude AS locations_latitude, locations.longitude AS locations_longitude, countries.id AS countries_id, countries.country_code2 AS countries_country_code2, countries.country_code3 AS countries_country_code3, countries.country_name AS countries_country_name, subtaxa.id AS subtaxa_id, subtaxa.subtaxa_author AS subtaxa_subtaxa_author, subtaxa.taxonomic_identifier AS subtaxa_taxonomic_identifier, taxonomies.id AS taxonomies_id, taxonomies.genus AS taxonomies_genus, taxonomies.species AS taxonomies_species, taxonomies.species_author AS taxonomies_species_author, taxonomies.cropname AS taxonomies_crop_name, taxonomies.ploidy AS taxonomies_ploidy FROM germinatebase LEFT JOIN locations ON germinatebase.location_id = locations.id LEFT JOIN countries ON countries.id = locations.country_id LEFT JOIN subtaxa ON subtaxa.id = germinatebase.subtaxa_id LEFT JOIN taxonomies ON taxonomies.id = germinatebase.taxonomy_id LEFT JOIN groupmembers ON groupmembers.foreign_id = germinatebase.id WHERE groupmembers.group_id = \"', groupId, '\" GROUP BY germinatebase.id'); PREPARE stmt FROM @sql; EXECUTE stmt; DEALLOCATE PREPARE stmt; ELSE SET @SQL = CONCAT(' SELECT germinatebase.*, locations.id AS locations_id, locations.state AS locations_state, locations.region AS locations_region, locations.site_name AS locations_site_name, locations.elevation AS locations_elevation, locations.latitude AS locations_latitude, locations.longitude AS locations_longitude, countries.id AS countries_id, countries.country_code2 AS countries_country_code2, countries.country_code3 AS countries_country_code3, countries.country_name AS countries_country_name, subtaxa.id AS subtaxa_id, subtaxa.subtaxa_author AS subtaxa_subtaxa_author, subtaxa.taxonomic_identifier AS subtaxa_taxonomic_identifier, taxonomies.id AS taxonomies_id, taxonomies.genus AS taxonomies_genus, taxonomies.species AS taxonomies_species, taxonomies.species_author AS taxonomies_species_author, taxonomies.cropname AS taxonomies_crop_name, taxonomies.ploidy AS taxonomies_ploidy, ', @SQL, ' FROM germinatebase LEFT JOIN locations ON germinatebase.location_id = locations.id LEFT JOIN countries ON countries.id = locations.country_id LEFT JOIN subtaxa ON subtaxa.id = germinatebase.subtaxa_id LEFT JOIN taxonomies ON taxonomies.id = germinatebase.taxonomy_id LEFT JOIN groupmembers ON groupmembers.foreign_id = germinatebase.id LEFT JOIN attributedata ON germinatebase.id = attributedata.foreign_id LEFT JOIN attributes ON attributes.id = attributedata.attribute_id WHERE attributes.target_table = \"germinatebase\" AND groupmembers.group_id = \"', groupId, '\" GROUP BY germinatebase.id'); PREPARE stmt FROM @sql; EXECUTE stmt; DEALLOCATE PREPARE stmt; END IF; END";

	private static final String QUERY_GERMINATEBASE_ATTRIBUTE_ACCESSION_DATA = "(IN includeAtts TINYINT, IN accessionIds TEXT) BEGIN SET @SQL = NULL; SET @@group_concat_max_len = 64000000; SET @QRY = CONCAT(' SELECT GROUP_CONCAT(DISTINCT CONCAT( \"MAX(CASE WHEN attribute_id = \", `attributes`.`id`, \" THEN attributedata.value END) AS \", \"`\", `attributes`.`name`, \"`\")) INTO @SQL FROM attributedata LEFT JOIN attributes ON attributes.id = attributedata.id WHERE attributes.target_table = \"germinatebase\";'); PREPARE stmtone FROM @QRY; EXECUTE stmtone; DEALLOCATE PREPARE stmtone; IF (@SQL IS NULL) OR NOT includeAtts THEN SET @SQL = CONCAT(' SELECT germinatebase.*, locations.id AS locations_id, locations.state AS locations_state, locations.region AS locations_region, locations.site_name AS locations_site_name, locations.elevation AS locations_elevation, locations.latitude AS locations_latitude, locations.longitude AS locations_longitude, countries.id AS countries_id, countries.country_code2 AS countries_country_code2, countries.country_code3 AS countries_country_code3, countries.country_name AS countries_country_name, subtaxa.id AS subtaxa_id, subtaxa.subtaxa_author AS subtaxa_subtaxa_author, subtaxa.taxonomic_identifier AS subtaxa_taxonomic_identifier, taxonomies.id AS taxonomies_id, taxonomies.genus AS taxonomies_genus, taxonomies.species AS taxonomies_species, taxonomies.species_author AS taxonomies_species_author, taxonomies.cropname AS taxonomies_crop_name, taxonomies.ploidy AS taxonomies_ploidy FROM germinatebase LEFT JOIN locations ON germinatebase.location_id = locations.id LEFT JOIN countries ON countries.id = locations.country_id LEFT JOIN subtaxa ON subtaxa.id = germinatebase.subtaxa_id LEFT JOIN taxonomies ON taxonomies.id = germinatebase.taxonomy_id LEFT JOIN groupmembers ON groupmembers.foreign_id = germinatebase.id WHERE germinatebase.id IN (', accessionIds ,') GROUP BY germinatebase.id'); PREPARE stmt FROM @sql; EXECUTE stmt; DEALLOCATE PREPARE stmt; ELSE SET @SQL = CONCAT(' SELECT germinatebase.*, locations.id AS locations_id, locations.state AS locations_state, locations.region AS locations_region, locations.site_name AS locations_site_name, locations.elevation AS locations_elevation, locations.latitude AS locations_latitude, locations.longitude AS locations_longitude, countries.id AS countries_id, countries.country_code2 AS countries_country_code2, countries.country_code3 AS countries_country_code3, countries.country_name AS countries_country_name, subtaxa.id AS subtaxa_id, subtaxa.subtaxa_author AS subtaxa_subtaxa_author, subtaxa.taxonomic_identifier AS subtaxa_taxonomic_identifier, taxonomies.id AS taxonomies_id, taxonomies.genus AS taxonomies_genus, taxonomies.species AS taxonomies_species, taxonomies.species_author AS taxonomies_species_author, taxonomies.cropname AS taxonomies_crop_name, taxonomies.ploidy AS taxonomies_ploidy, ', @SQL, ' FROM germinatebase LEFT JOIN locations ON germinatebase.location_id = locations.id LEFT JOIN countries ON countries.id = locations.country_id LEFT JOIN subtaxa ON subtaxa.id = germinatebase.subtaxa_id LEFT JOIN taxonomies ON taxonomies.id = germinatebase.taxonomy_id LEFT JOIN groupmembers ON groupmembers.foreign_id = germinatebase.id LEFT JOIN attributedata ON germinatebase.id = attributedata.foreign_id LEFT JOIN attributes ON attributes.id = attributedata.attribute_id WHERE attributes.target_table = \"germinatebase\" AND germinatebase.id IN (', accessionIds, ') GROUP BY germinatebase.id'); PREPARE stmt FROM @sql; EXECUTE stmt; DEALLOCATE PREPARE stmt; END IF; END";

	private static final String QUERY_DATASET_META = "() BEGIN DELETE FROM datasetmeta WHERE NOT EXISTS (SELECT 1 FROM datasets WHERE datasets.is_external = 1 AND datasets.id = datasetmeta.dataset_id); SELECT @max := IFNULL(MAX(id)+1, 1) FROM datasetmeta; SET @alter_statement = concat('ALTER TABLE `datasetmeta` AUTO_INCREMENT = ', @max); PREPARE stmt FROM @alter_statement; EXECUTE stmt; DEALLOCATE PREPARE stmt; INSERT INTO datasetmeta (dataset_id, nr_of_data_points, nr_of_data_objects) SELECT datasets.id, ( COALESCE (ac.c, 0) + COALESCE (pc.c, 0) + COALESCE (cc.c, 0) + COALESCE(cmc.c, 0)) AS 'nr_of_data_points', ( COALESCE (ad.d, 0) + COALESCE (pd.d, 0) + COALESCE (cd.d, 0) + COALESCE(cmd.d, 0)) AS 'nr_of_data_objects' FROM datasets LEFT JOIN datasetstates ON datasetstates.id = datasets.dataset_state_id LEFT JOIN datasetpermissions ON datasetpermissions.dataset_id = datasets.id LEFT JOIN experiments ON experiments.id = datasets.experiment_id LEFT JOIN experimenttypes ON experimenttypes.id = experiments.experiment_type_id LEFT JOIN ( SELECT dataset_id, COUNT(1) AS c FROM allelefrequencydata GROUP BY dataset_id ) ac ON ac.dataset_id = datasets.id LEFT JOIN ( SELECT dataset_id, COUNT(1) AS c FROM phenotypedata GROUP BY dataset_id ) pc ON pc.dataset_id = datasets.id LEFT JOIN ( SELECT dataset_id, COUNT(1) AS c FROM climatedata GROUP BY dataset_id ) cc ON cc.dataset_id = datasets.id LEFT JOIN ( SELECT dataset_id, COUNT(1) AS c FROM compounddata GROUP BY dataset_id ) cmc ON cmc.dataset_id = datasets.id LEFT JOIN ( SELECT distinct_entries.dataset_id, count(1) AS d FROM ( SELECT DISTINCT dataset_id, germinatebase_id FROM allelefrequencydata ) AS distinct_entries GROUP BY distinct_entries.dataset_id ) ad ON ad.dataset_id = datasets.id LEFT JOIN ( SELECT distinct_entries.dataset_id, count(1) AS d FROM ( SELECT DISTINCT dataset_id, germinatebase_id FROM phenotypedata ) AS distinct_entries GROUP BY distinct_entries.dataset_id ) pd ON pd.dataset_id = datasets.id LEFT JOIN ( SELECT distinct_entries.dataset_id, count(1) AS d FROM ( SELECT DISTINCT dataset_id, location_id FROM climatedata ) AS distinct_entries GROUP BY distinct_entries.dataset_id ) cd ON cd.dataset_id = datasets.id LEFT JOIN ( SELECT distinct_entries.dataset_id, count(1) AS d FROM ( SELECT DISTINCT dataset_id, germinatebase_id FROM compounddata ) AS distinct_entries GROUP BY distinct_entries.dataset_id ) cmd ON cmd.dataset_id = datasets.id WHERE is_external = 0; END";

	private static final String QUERY_UPDATE_AUTO_INCREMENT = "(IN tableName TEXT) BEGIN DECLARE theCount BIGINT; SET @SEL = CONCAT('SELECT MAX(id)+1 INTO @theCount FROM ', tableName); START TRANSACTION; PREPARE stmt FROM @SEL; EXECUTE stmt; DEALLOCATE PREPARE stmt; SET @INS = CONCAT('ALTER TABLE ', tableName, ' AUTO_INCREMENT = ', @theCount); PREPARE stmt FROM @INS; EXECUTE stmt; DEALLOCATE PREPARE stmt; COMMIT; END";

//	private static final String QUERY_TABLE_SEARCH = "(IN databaseName TEXT, IN tableName TEXT, IN searchString TEXT) BEGIN SET @SQL = NULL; SET @@group_concat_max_len = 32000; SET @query := ( SELECT CONCAT( \"SELECT * FROM \", tableName, \" WHERE \", GROUP_CONCAT(CONCAT(COLUMN_NAME, ' LIKE ', '\"%', searchString, '%\"') separator ' OR ')) FROM INFORMATION_SCHEMA.columns WHERE TABLE_NAME = tableName AND TABLE_SCHEMA = databaseName); PREPARE s1 FROM @query; EXECUTE s1; DEALLOCATE PREPARE s1; END";

	private static final String[] PROCEDURES = {PHENOTYPE_DATA, PHENOTYPE_DATA_COMPLETE, PHENOTYPE_DATA_PHENOTYPE, COMPOUND_DATA, COMPOUND_DATA_COMPOUND, COMPOUND_DATA_COMPLETE, GERMINATEBASE_ATTRIBUTE_DATA, GERMINATEBASE_ATTRIBUTE_GROUP_DATA, GERMINATEBASE_ATTRIBUTE_ACCESSION_DATA, DATASET_META, UPDATE_AUTO_INCREMENT};
	private static final String[] QUERIES    = {QUERY_PHENOTYPE_DATA, QUERY_PHENOTYPE_DATA_COMPLETE, QUERY_PHENOTYPE_DATA_PHENOTYPE, QUERY_COMPOUND_DATA, QUERY_COMPOUND_DATA_COMPOUND, QUERY_COMPOUND_DATA_COMPLETE, QUERY_GERMINATEBASE_ATTRIBUTE_DATA, QUERY_GERMINATEBASE_ATTRIBUTE_GROUP_DATA, QUERY_GERMINATEBASE_ATTRIBUTE_ACCESSION_DATA, QUERY_DATASET_META, QUERY_UPDATE_AUTO_INCREMENT};

	@Override
	protected String[] getNames()
	{
		return PROCEDURES;
	}

	@Override
	protected String[] getQueries()
	{
		return QUERIES;
	}

	@Override
	protected String getDropStatement()
	{
		return DROP_PROCEDURE;
	}

	@Override
	protected String getCreateStatement()
	{
		return CREATE_PROCEDURE;
	}
}
